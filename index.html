<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Art History - R√©seau Dynamique</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        :root {
            --bg: #f4f6f8; --panel-bg: rgba(255,255,255,0.95);
            --text: #2c3e50; --grey: #7f8c8d;
            --blue: #3498db; --french: #00bcd4; --red: #e74c3c;
        }
        body { margin: 0; overflow: hidden; font-family: 'Segoe UI', sans-serif; background: var(--bg); }
        
        /* --- SIDEBAR GAUCHE --- */
        #sidebar {
            position: absolute; top: 15px; left: 15px; width: 320px;
            max-height: 90vh; overflow-y: auto;
            background: var(--panel-bg); backdrop-filter: blur(10px);
            border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            padding: 20px; box-sizing: border-box;
            transition: transform 0.3s ease; z-index: 20;
        }
        #sidebar.hidden { transform: translateX(-350px); }
        
        h2 { margin: 0 0 5px 0; font-size: 20px; color: var(--text); }
        h4 { margin: 15px 0 10px 0; font-size: 12px; text-transform: uppercase; color: var(--grey); border-bottom: 1px solid #eee; padding-bottom: 5px; }
        
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 13px; }
        .stat-val { font-weight: bold; color: var(--blue); }
        
        /* Bar Charts */
        .bar-item { display: flex; align-items: center; margin-bottom: 4px; font-size: 11px; }
        .bar-label { width: 120px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; text-align: right; padding-right: 8px; }
        .bar-bg { flex-grow: 1; background: #eee; height: 6px; border-radius: 3px; }
        .bar-fill { height: 100%; background: var(--blue); border-radius: 3px; }
        .bar-num { width: 30px; text-align: right; color: #999; margin-left: 5px; }

        /* --- SIDEBAR DROITE (CONTROLS) --- */
        #controls-panel {
            position: absolute; top: 15px; right: 15px; width: 280px;
            background: var(--panel-bg); backdrop-filter: blur(10px);
            border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            padding: 15px; z-index: 20;
        }
        
        .search-box { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        .filter-group label { display: block; margin: 5px 0; font-size: 13px; cursor: pointer; }
        .legend-item { display: flex; align-items: center; gap: 8px; font-size: 12px; margin-bottom: 4px; }
        .shape { width: 12px; height: 12px; display: inline-block; }
        .shape.circle { border-radius: 50%; background: #333; }
        .shape.square { background: #bdc3c7; }
        .shape.diamond { transform: rotate(45deg); background: var(--french); width: 8px; height: 8px; }
        
        /* Legend Univ */
        #univ-legend { margin-top: 5px; padding-left: 24px; display: block; }
        .univ-item { display: flex; align-items: center; margin-bottom: 3px; font-size: 11px; color: #555; }
        .univ-dot { width: 8px; height: 8px; border-radius: 50%; margin-right: 6px; display: inline-block; }

        /* --- DETAILS PANEL --- */
        #details-view { margin-top: 20px; padding-top: 15px; border-top: 2px solid #eee; display: none; }
        .detail-name { font-size: 18px; font-weight: bold; color: var(--text); }
        .collab-box { background: #fff5f5; border-left: 3px solid var(--red); padding: 10px; margin-top: 10px; font-size: 12px; }
        
        /* --- GRAPH --- */
        #graph { width: 100vw; height: 100vh; cursor: grab; }
        #graph:active { cursor: grabbing; }
        
        .btn-toggle { position: absolute; top: 15px; left: 345px; width: 30px; height: 30px; background: white; border-radius: 50%; border: none; box-shadow: 0 2px 5px rgba(0,0,0,0.1); cursor: pointer; transition: left 0.3s; z-index: 25; }
        .btn-bottom { position: absolute; bottom: 20px; right: 20px; padding: 8px 15px; background: white; border: 1px solid #ccc; border-radius: 6px; cursor: pointer; }

    </style>
</head>
<body>

<div id="sidebar">
    <h2>Art History Network</h2>
    <div style="font-size:12px; color:#777; margin-bottom:15px">Dashboard & D√©tails</div>
    
    <div id="default-view">
        <div class="stat-row"><span>Chercheurs visibles</span><span class="stat-val" id="st-auth">-</span></div>
        <div class="stat-row"><span>Sujets visibles</span><span class="stat-val" id="st-topic">-</span></div>
        <div class="stat-row"><span>Liens actifs</span><span class="stat-val" id="st-link">-</span></div>

        <h4>Top 10 Universit√©s (Visible)</h4>
        <div id="chart-univ"></div>

        <h4>Top 10 Sujets (Visible)</h4>
        <div id="chart-topic"></div>
    </div>

    <div id="details-view">
        <button onclick="closeDetails()" style="float:right; border:none; background:none; cursor:pointer; font-size:16px; color:#999">√ó</button>
        <div id="detail-content"></div>
    </div>
</div>

<button class="btn-toggle" id="btn-toggle" onclick="toggleSidebar()">‚ùÆ</button>

<div id="controls-panel">
    <h4>Recherche & Filtres</h4>
    <input type="text" id="search" class="search-box" placeholder="Focus sur (Entr√©e)..." onchange="performSearch()">
    
    <div style="margin-top:10px;" class="filter-group">
        <div class="legend-item"><span class="shape circle"></span> <label><input type="checkbox" id="cb-auth" checked onchange="recalcGraph()"> Chercheurs</label></div>
        <div class="legend-item"><span class="shape square"></span> <label><input type="checkbox" id="cb-topic" checked onchange="recalcGraph()"> Sujets G√©n√©raux</label></div>
        <div class="legend-item"><span class="shape diamond"></span> <label><input type="checkbox" id="cb-french" checked onchange="recalcGraph()"> Sujets France</label></div>
    </div>
    
    <div style="margin-top:10px; border-top:1px solid #eee; padding-top:10px;" class="filter-group">
        <label style="font-weight:600; font-size:12px; margin-bottom:5px;">
            <input type="checkbox" id="cb-colors" checked onchange="toggleColors()"> üé® Couleurs Universit√©s
        </label>
        <div id="univ-legend"></div>
    </div>

    <div style="margin-top:15px; border-top:1px solid #eee; padding-top:10px; font-size:12px;">
        Degr√© min. Sujets (Tout type): <strong id="val-slid">1</strong>
        <input type="range" id="slider" min="1" max="50" value="1" style="width:100%" oninput="recalcGraph()">
    </div>
</div>

<div id="graph"></div>
<button class="btn-bottom" onclick="resetCam()">‚úõ Centrer</button>

<script>
    // --- VARIABLES GLOBALES ---
    // Donn√©es "Sources" (Ne changent jamais)
    let allNodes = [], allLinks = [];
    
    // Donn√©es "Actuelles" (Filtr√©es)
    let curNodes = [], curLinks = [];

    let width, height, simulation;
    let link, node, label, glow; // S√©lections D3
    let universities = [];
    
    const colorScale = d3.scaleOrdinal(d3.schemeCategory10);
    const symDiamond = d3.symbol().type(d3.symbolDiamond).size(150);
    const symSquare = d3.symbol().type(d3.symbolSquare).size(120);
    const symCircle = d3.symbol().type(d3.symbolCircle);

    // --- SETUP D3 ---
    width = window.innerWidth; height = window.innerHeight;
    const svg = d3.select("#graph").append("svg").attr("width", "100%").attr("height", "100%").on("click", bgClick);
    const g = svg.append("g");
    const zoom = d3.zoom().scaleExtent([0.1, 8]).on("zoom", e => g.attr("transform", e.transform));
    svg.call(zoom);

    // Groupes pour l'ordre d'affichage (z-index via SVG)
    const gLinks = g.append("g").attr("class", "links");
    const gGlow = g.append("g").attr("class", "glows");
    const gNodes = g.append("g").attr("class", "nodes");
    const gLabels = g.append("g").attr("class", "labels");

    // Glow Filter
    const defs = svg.append("defs");
    const filter = defs.append("filter").attr("id", "glow");
    filter.append("feGaussianBlur").attr("stdDeviation", "4").attr("result", "coloredBlur");
    const feMerge = filter.append("feMerge");
    feMerge.append("feMergeNode").attr("in", "coloredBlur");
    feMerge.append("feMergeNode").attr("in", "SourceGraphic");

    // --- CHARGEMENT ---
    Promise.all([
        d3.json("data_graph.json"),
        d3.json("data_stats.json")
    ]).then(([graphData, statsData]) => {
        // Stockage des donn√©es sources
        allNodes = graphData.nodes;
        allLinks = graphData.links;
        
        // Setup L√©gende
        universities = [...new Set(allNodes.filter(d => d.Type === 'author').map(d => d.university))].sort();
        colorScale.domain(universities);
        buildLegend();

        // Initialisation Simulation
        simulation = d3.forceSimulation()
            .force("link", d3.forceLink().id(d => d.id).distance(90))
            .force("charge", d3.forceManyBody().strength(-300))
            .force("center", d3.forceCenter(width/2, height/2))
            .force("collide", d3.forceCollide().radius(d => d.radius + 5).iterations(2));

        // Premier calcul
        recalcGraph();

    }).catch(err => {
        console.error(err);
        alert("ERREUR : Lancez un serveur local ! (python -m http.server)");
    });

    // --- C≈íUR DU SYST√àME : FILTRE ET RECHARGEMENT ---
    function recalcGraph() {
        const showAuth = document.getElementById("cb-auth").checked;
        const showTopic = document.getElementById("cb-topic").checked;
        const showFr = document.getElementById("cb-french").checked;
        const minDeg = parseInt(document.getElementById("slider").value);
        document.getElementById("val-slid").innerText = minDeg;

        // 1. Filtrer les N≈ìuds (Selon cat√©gorie et slider)
        let tempNodes = allNodes.filter(n => {
            if (n.Type === 'author' && !showAuth) return false;
            // Slider s'applique √† tous les topics
            if ((n.Type === 'macro_topic' || n.Type === 'french_tag') && n.count < minDeg) return false;
            if (n.Type === 'macro_topic' && !showTopic) return false;
            if (n.Type === 'french_tag' && !showFr) return false;
            return true;
        });

        // 2. Cr√©er un Set des IDs visibles pour filtrer les liens
        const visibleNodeIds = new Set(tempNodes.map(n => n.id));

        // 3. Filtrer les Liens (Il faut que Source ET Target soient visibles)
        // Attention : D3 modifie les objets links, on utilise l'ID original si dispo ou l'objet
        let tempLinks = allLinks.filter(l => {
            const s = l.source.id || l.source;
            const t = l.target.id || l.target;
            return visibleNodeIds.has(s) && visibleNodeIds.has(t);
        });

        // 4. NETTOYAGE ORPHELINS (Cascade)
        // On ne garde que les n≈ìuds qui ont au moins un lien dans tempLinks
        // Sauf si c'est un auteur "collab", on peut vouloir le garder (optionnel, ici on nettoie tout)
        
        const activeNodeIds = new Set();
        tempLinks.forEach(l => {
            activeNodeIds.add(l.source.id || l.source);
            activeNodeIds.add(l.target.id || l.target);
        });

        // Application du filtre orphelin
        curNodes = tempNodes.filter(n => activeNodeIds.has(n.id));
        
        // Recalcul final des liens (car on a peut-√™tre supprim√© des n≈ìuds orphelins qui avaient des liens fant√¥mes)
        // (En th√©orie non, car activeNodeIds est bas√© sur les liens, mais par s√©curit√©)
        const finalNodeIds = new Set(curNodes.map(n => n.id));
        curLinks = tempLinks.filter(l => {
            const s = l.source.id || l.source;
            const t = l.target.id || l.target;
            return finalNodeIds.has(s) && finalNodeIds.has(t);
        });

        // 5. Mise √† jour D3
        updateD3();
        updateStats();
        updateCharts();
    }

    function updateD3() {
        // Stop la simulation pendant la mise √† jour
        simulation.stop();

        // --- UPDATE LINKS ---
        link = gLinks.selectAll("line")
            .data(curLinks, d => (d.source.id || d.source) + "-" + (d.target.id || d.target));
        
        link.exit().remove(); // Supprime les anciens

        const linkEnter = link.enter().append("line")
            .attr("stroke", "#ccc").attr("stroke-width", 0.6);
        
        link = linkEnter.merge(link);

        // --- UPDATE GLOWS ---
        glow = gGlow.selectAll("path")
            .data(curNodes.filter(d => d.france_type === 'collab' || d.france_type === 'both'), d => d.id);
        
        glow.exit().remove();

        const glowEnter = glow.enter().append("path")
            .attr("d", d => symCircle.size((d.radius+6)*(d.radius+6)*3)())
            .attr("fill", "none")
            .attr("stroke-width", 3)
            .style("filter", "url(#glow)").attr("opacity", 0.6).attr("pointer-events", "none");
        
        glow = glowEnter.merge(glow);

        // --- UPDATE NODES ---
        node = gNodes.selectAll("path")
            .data(curNodes, d => d.id);
        
        node.exit().remove(); // L'animation de disparition est brutale mais efficace pour le "reload"

        const nodeEnter = node.enter().append("path")
            .attr("d", d => {
                if (d.Type === 'french_tag') return symDiamond();
                if (d.Type === 'macro_topic') return symSquare();
                return symCircle.size(d.radius*d.radius*3.14)();
            })
            .attr("stroke", "#fff").attr("stroke-width", 1)
            .on("click", nodeClick)
            .call(d3.drag().on("start", dragstart).on("drag", dragged).on("end", dragend));
        
        node = nodeEnter.merge(node);

        // --- UPDATE LABELS ---
        label = gLabels.selectAll("text")
            .data(curNodes, d => d.id);
        
        label.exit().remove();

        const labelEnter = label.enter().append("text")
            .text(d => d.label).attr("dx", d => d.radius + 5).attr("dy", 4)
            .attr("font-size", d => d.Type === 'author' ? "10px" : "9px")
            .attr("fill", "#222") // Sera √©cras√© par updateColors
            .style("pointer-events", "none");
        
        label = labelEnter.merge(label);

        // Appliquer les couleurs correctes
        updateColors();

        // Relancer la simulation avec les nouvelles donn√©es
        simulation.nodes(curNodes);
        simulation.force("link").links(curLinks);
        simulation.alpha(1).restart(); // Le "1" force le graphe √† bouger et se r√©organiser
    }

    // --- COULEURS ---
    function updateColors() {
        const showColors = document.getElementById("cb-colors").checked;
        const legendDiv = document.getElementById("univ-legend");
        legendDiv.style.display = showColors ? "block" : "none";

        node.attr("fill", d => {
            if (d.Type === 'french_tag') return "var(--french)";
            if (d.Type === 'macro_topic') return "#bdc3c7";
            return showColors ? colorScale(d.university) : "#444";
        });

        glow.attr("stroke", d => showColors ? colorScale(d.university) : "#e74c3c");
        label.attr("fill", d => d.Type === 'author' ? "#222" : "#888");
    }

    function toggleColors() {
        updateColors();
    }

    // --- STATS & CHARTS ---
    function updateStats() {
        document.getElementById("st-auth").innerText = curNodes.filter(n => n.Type === 'author').length;
        document.getElementById("st-topic").innerText = curNodes.filter(n => n.Type !== 'author').length;
        document.getElementById("st-link").innerText = curLinks.length;
    }

    function updateCharts() {
        // Recalculer les tops bas√©s sur curNodes
        const univCounts = {};
        const topicCounts = {};

        curNodes.forEach(n => {
            if (n.Type === 'author') {
                univCounts[n.university] = (univCounts[n.university] || 0) + 1;
            } else {
                topicCounts[n.label] = n.count; // Utilise le count pr√©-calcul√©
            }
        });

        const sortedUniv = Object.entries(univCounts).sort((a,b) => b[1] - a[1]).slice(0, 10);
        const sortedTopic = Object.entries(topicCounts).sort((a,b) => b[1] - a[1]).slice(0, 10);

        drawChart("#chart-univ", sortedUniv);
        drawChart("#chart-topic", sortedTopic);
    }

    function drawChart(id, data) {
        const div = d3.select(id);
        div.html(""); // Clear old chart
        if (data.length === 0) return;

        const max = data[0][1];
        data.forEach(([k, v]) => {
            const row = div.append("div").attr("class", "bar-item");
            row.append("div").attr("class", "bar-label").text(k).attr("title", k);
            const bg = row.append("div").attr("class", "bar-bg");
            bg.append("div").attr("class", "bar-fill").style("width", (v/max*100)+"%");
            row.append("div").attr("class", "bar-num").text(v);
        });
    }

    function buildLegend() {
        const container = document.getElementById("univ-legend");
        let html = "";
        universities.forEach(u => {
            html += `<div class="univ-item"><span class="univ-dot" style="background:${colorScale(u)}"></span>${u}</div>`;
        });
        container.innerHTML = html;
    }

    // --- INTERACTIONS ---
    function nodeClick(event, d) {
        event.stopPropagation();
        activeId = d.id;
        
        const neigh = new Set([d.id]);
        curLinks.forEach(l => {
            if(l.source.id === d.id) neigh.add(l.target.id);
            if(l.target.id === d.id) neigh.add(l.source.id);
        });

        node.attr("opacity", n => neigh.has(n.id) ? 1 : 0.1);
        label.attr("opacity", n => neigh.has(n.id) ? 1 : 0);
        link.attr("opacity", l => (l.source.id === d.id || l.target.id === d.id) ? 1 : 0.05);
        
        showDetails(d);
    }

    function bgClick() {
        activeId = null;
        node.attr("opacity", 1); link.attr("opacity", 1); label.attr("opacity", 1);
        closeDetails();
    }

    function showDetails(d) {
        document.getElementById("default-view").style.display = "none";
        document.getElementById("details-view").style.display = "block";
        const cont = document.getElementById("detail-content");
        
        let html = `<div class="detail-name">${d.label}</div>`;
        html += `<div style="color:var(--grey); margin-bottom:10px">${d.Type==='author'?d.university:'Topic'}</div>`;
        
        if (d.Type === 'author') {
             if (d.france_type === 'collab' || d.france_type === 'both') {
                html += `<div class="collab-box">
                    <strong>üá´üá∑ Collaboration</strong><br>
                    üèõ ${d.collab_inst}<br>
                    üìÑ <i>"${d.collab_article}"</i><br>
                    üè∑ Th√®me: ${d.collab_theme}
                </div>`;
             } else if (d.france_type === 'study') {
                html += `<div style="color:var(--french); margin-top:10px">‚òÖ √âtudie la France</div>`;
             }
        } else {
            html += `<div>Cit√© <strong>${d.count}</strong> fois.</div>`;
        }
        cont.innerHTML = html;
    }

    function closeDetails() {
        document.getElementById("details-view").style.display = "none";
        document.getElementById("default-view").style.display = "block";
    }

    function performSearch() {
        const val = document.getElementById("search").value.toLowerCase();
        if (!val) return;
        const found = curNodes.find(n => n.label.toLowerCase().includes(val));
        
        if (found) {
            const scale = 2.5;
            const x = -found.x * scale + width / 2;
            const y = -found.y * scale + height / 2;
            svg.transition().duration(750).call(zoom.transform, d3.zoomIdentity.translate(x, y).scale(scale));
            nodeClick(new Event('click'), found);
        } else {
            alert("Introuvable dans la vue actuelle (v√©rifiez les filtres).");
        }
    }

    function resetCam() { svg.transition().duration(750).call(zoom.transform, d3.zoomIdentity); }
    
    function toggleSidebar() {
        const sb = document.getElementById("sidebar");
        const btn = document.getElementById("btn-toggle");
        if (sb.classList.contains("hidden")) {
            sb.classList.remove("hidden"); btn.style.left = "345px"; btn.innerHTML = "‚ùÆ";
        } else {
            sb.classList.add("hidden"); btn.style.left = "20px"; btn.innerHTML = "‚ùØ";
        }
    }
    
    function dragstart(event, d) { if (!event.active) simulation.alphaTarget(0.3).restart(); d.fx = d.x; d.fy = d.y; }
    function dragged(event, d) { d.fx = event.x; d.fy = event.y; }
    function dragend(event, d) { if (!event.active) simulation.alphaTarget(0); d.fx = null; d.fy = null; }

    // Simulation tick
    simulation.on("tick", () => {
        link.attr("x1", d => d.source.x).attr("y1", d => d.source.y).attr("x2", d => d.target.x).attr("y2", d => d.target.y);
        node.attr("transform", d => `translate(${d.x},${d.y})`);
        glow.attr("transform", d => `translate(${d.x},${d.y})`);
        label.attr("x", d => d.x).attr("y", d => d.y);
    });

</script>
</body>
</html>
