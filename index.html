<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <title>Art History - Network Visualization</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
      :root {
        --bg: #f4f6f8;
        --panel-bg: rgba(255, 255, 255, 0.95);
        --text: #2c3e50;
        --grey: #7f8c8d;
        --blue: #3498db;
        --french: #00bcd4;
        --red: #e74c3c;
      }
      body {
        margin: 0;
        overflow: hidden;
        font-family: "Segoe UI", sans-serif;
        background: var(--bg);
      }

      /* --- SIDEBAR GAUCHE (DASHBOARD) --- */
      #sidebar {
        position: absolute;
        top: 15px;
        left: 15px;
        width: 320px;
        max-height: 90vh;
        overflow-y: auto;
        background: var(--panel-bg);
        backdrop-filter: blur(10px);
        border-radius: 12px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        padding: 20px;
        box-sizing: border-box;
        transition: transform 0.3s ease;
        z-index: 20;
      }
      #sidebar.hidden {
        transform: translateX(-350px);
      }

      h2 {
        margin: 0 0 5px 0;
        font-size: 20px;
        color: var(--text);
      }
      h4 {
        margin: 15px 0 10px 0;
        font-size: 12px;
        text-transform: uppercase;
        color: var(--grey);
        border-bottom: 1px solid #eee;
        padding-bottom: 5px;
      }

      .stat-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 5px;
        font-size: 13px;
      }
      .stat-val {
        font-weight: bold;
        color: var(--blue);
      }

      /* Charts */
      .bar-item {
        display: flex;
        align-items: center;
        margin-bottom: 4px;
        font-size: 11px;
      }
      .bar-label {
        width: 120px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        text-align: right;
        padding-right: 8px;
      }
      .bar-bg {
        flex-grow: 1;
        background: #eee;
        height: 6px;
        border-radius: 3px;
      }
      .bar-fill {
        height: 100%;
        background: var(--blue);
        border-radius: 3px;
      }
      .bar-num {
        width: 30px;
        text-align: right;
        color: #999;
        margin-left: 5px;
      }

      /* --- SIDEBAR DROITE (CONTROLS) --- */
      #controls-panel {
        position: absolute;
        top: 15px;
        right: 15px;
        width: 280px;
        background: var(--panel-bg);
        backdrop-filter: blur(10px);
        border-radius: 12px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        padding: 15px;
        z-index: 20;
      }

      .search-box {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 6px;
        box-sizing: border-box;
      }
      .filter-group label {
        display: block;
        margin: 5px 0;
        font-size: 13px;
        cursor: pointer;
      }
      .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 12px;
        margin-bottom: 4px;
      }
      .shape {
        width: 12px;
        height: 12px;
        display: inline-block;
      }
      .shape.circle {
        border-radius: 50%;
        background: #333;
      }
      .shape.square {
        background: #bdc3c7;
      }
      .shape.diamond {
        transform: rotate(45deg);
        background: var(--french);
        width: 8px;
        height: 8px;
      }

      /* --- DETAILS PANEL --- */
      #details-view {
        margin-top: 20px;
        padding-top: 15px;
        border-top: 2px solid #eee;
        display: none;
      }
      .detail-name {
        font-size: 18px;
        font-weight: bold;
        color: var(--text);
      }
      .collab-box {
        background: #fff5f5;
        border-left: 3px solid var(--red);
        padding: 10px;
        margin-top: 10px;
        font-size: 12px;
      }
      .tag-badge {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 11px;
        background: #eee;
        margin: 2px;
      }
      .tag-badge.french {
        background: var(--french);
        color: white;
      }

      /* --- GRAPH --- */
      #graph {
        width: 100vw;
        height: 100vh;
        cursor: grab;
      }
      #graph:active {
        cursor: grabbing;
      }

      .btn-toggle {
        position: absolute;
        top: 15px;
        left: 345px;
        width: 30px;
        height: 30px;
        background: white;
        border-radius: 50%;
        border: none;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        cursor: pointer;
        transition: left 0.3s;
        z-index: 25;
      }
      .btn-bottom {
        position: absolute;
        bottom: 20px;
        right: 20px;
        padding: 8px 15px;
        background: white;
        border: 1px solid #ccc;
        border-radius: 6px;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <div id="sidebar">
      <h2>Art History Network</h2>
      <div style="font-size: 12px; color: #777; margin-bottom: 15px">
        Dashboard & D√©tails
      </div>

      <div id="default-view">
        <div class="stat-row">
          <span>Chercheurs visibles</span
          ><span class="stat-val" id="st-auth">-</span>
        </div>
        <div class="stat-row">
          <span>Sujets visibles</span
          ><span class="stat-val" id="st-topic">-</span>
        </div>
        <div class="stat-row">
          <span>Liens actifs</span><span class="stat-val" id="st-link">-</span>
        </div>

        <h4>Top 6 Universit√©s</h4>
        <div id="chart-univ"></div>

        <h4>Top 10 Sujets</h4>
        <div id="chart-topic"></div>
      </div>

      <div id="details-view">
        <button
          onclick="closeDetails()"
          style="
            float: right;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 16px;
            color: #999;
          "
        >
          √ó
        </button>
        <div id="detail-content"></div>
      </div>
    </div>

    <button class="btn-toggle" id="btn-toggle" onclick="toggleSidebar()">
      ‚ùÆ
    </button>

    <div id="controls-panel">
      <h4>Recherche & Filtres</h4>
      <input
        type="text"
        id="search"
        class="search-box"
        placeholder="Focus sur (Entr√©e)..."
        onchange="performSearch()"
      />

      <div style="margin-top: 10px" class="filter-group">
        <div class="legend-item">
          <span class="shape circle"></span>
          <label
            ><input type="checkbox" id="cb-auth" checked onchange="update()" />
            Chercheurs</label
          >
        </div>
        <div class="legend-item">
          <span class="shape square"></span>
          <label
            ><input type="checkbox" id="cb-topic" checked onchange="update()" />
            Sujets G√©n√©raux</label
          >
        </div>
        <div class="legend-item">
          <span class="shape diamond"></span>
          <label
            ><input
              type="checkbox"
              id="cb-french"
              checked
              onchange="update()"
            />
            Sujets France</label
          >
        </div>
      </div>

      <div style="margin-top: 10px; font-size: 12px">
        Degr√© min. Sujets (Tout type): <strong id="val-slid">1</strong>
        <input
          type="range"
          id="slider"
          min="1"
          max="40"
          value="1"
          style="width: 100%"
          oninput="update()"
        />
      </div>
    </div>

    <div id="graph"></div>
    <button class="btn-bottom" onclick="resetCam()">‚úõ Centrer</button>

    <script>
      // --- VARIABLES GLOBALES ---
      let nodes = [],
        links = [];
      let width, height;
      let simulation, link, node, label, glow;
      let activeId = null;

      const colorScale = d3.scaleOrdinal(d3.schemeCategory10);
      const symDiamond = d3.symbol().type(d3.symbolDiamond).size(150);
      const symSquare = d3.symbol().type(d3.symbolSquare).size(120);
      const symCircle = d3.symbol().type(d3.symbolCircle);

      // --- SETUP D3 ---
      width = window.innerWidth;
      height = window.innerHeight;

      const svg = d3
        .select("#graph")
        .append("svg")
        .attr("width", "100%")
        .attr("height", "100%")
        .on("click", bgClick);

      const g = svg.append("g");
      const zoom = d3
        .zoom()
        .scaleExtent([0.1, 8])
        .on("zoom", (e) => g.attr("transform", e.transform));
      svg.call(zoom);

      // Glow Filter Definition
      const defs = svg.append("defs");
      const filter = defs.append("filter").attr("id", "glow");
      filter
        .append("feGaussianBlur")
        .attr("stdDeviation", "4")
        .attr("result", "coloredBlur");
      const feMerge = filter.append("feMerge");
      feMerge.append("feMergeNode").attr("in", "coloredBlur");
      feMerge.append("feMergeNode").attr("in", "SourceGraphic");

      // --- CHARGEMENT DES JSON ---
      Promise.all([d3.json("network_data_final.json"), d3.json("data_stats.json")])
        .then(([graphData, statsData]) => {
          nodes = graphData.nodes;
          links = graphData.links;

          // Initialiser Dashboard
          drawChart("#chart-univ", statsData.univs);
          drawChart("#chart-topic", statsData.topics);

          // Lancer Graphe
          initGraph();
          update(); // Applique filtres initiaux
        })
        .catch((err) => {
          console.error(err);
          alert(
            "ERREUR CHARGEMENT !\n\nVous devez utiliser un serveur local pour charger les fichiers JSON.\n\nUtilisez 'Live Server' sur VS Code ou 'python -m http.server' dans le terminal."
          );
        });

      function initGraph() {
        simulation = d3
          .forceSimulation(nodes)
          .force(
            "link",
            d3
              .forceLink(links)
              .id((d) => d.id)
              .distance(90)
          )
          .force("charge", d3.forceManyBody().strength(-300))
          .force("center", d3.forceCenter(width / 2, height / 2))
          .force(
            "collide",
            d3
              .forceCollide()
              .radius((d) => d.radius + 5)
              .iterations(2)
          );

        link = g
          .append("g")
          .selectAll("line")
          .data(links)
          .join("line")
          .attr("stroke", "#ccc")
          .attr("stroke-width", 0.6);

        glow = g
          .append("g")
          .selectAll("path")
          .data(
            nodes.filter(
              (d) => d.france_type === "collab" || d.france_type === "both"
            )
          )
          .join("path")
          .attr("d", (d) =>
            symCircle.size((d.radius + 6) * (d.radius + 6) * 3)()
          )
          .attr("fill", "none")
          .attr("stroke", (d) => colorScale(d.university))
          .attr("stroke-width", 3)
          .style("filter", "url(#glow)")
          .attr("opacity", 0.6)
          .attr("pointer-events", "none");

        node = g
          .append("g")
          .selectAll("path")
          .data(nodes)
          .join("path")
          .attr("d", (d) => {
            if (d.Type === "french_tag") return symDiamond();
            if (d.Type === "macro_topic") return symSquare();
            return symCircle.size(d.radius * d.radius * 3.14)();
          })
          .attr("fill", (d) => {
            if (d.Type === "french_tag") return "var(--french)";
            if (d.Type === "macro_topic") return "#bdc3c7";
            return colorScale(d.university);
          })
          .attr("stroke", "#fff")
          .attr("stroke-width", 1)
          .on("click", nodeClick)
          .call(
            d3
              .drag()
              .on("start", dragstart)
              .on("drag", dragged)
              .on("end", dragend)
          );

        label = g
          .append("g")
          .selectAll("text")
          .data(nodes)
          .join("text")
          .text((d) => d.label)
          .attr("dx", (d) => d.radius + 5)
          .attr("dy", 4)
          .attr("font-size", (d) => (d.Type === "author" ? "10px" : "9px"))
          .attr("fill", (d) => (d.Type === "author" ? "#222" : "#888"))
          .style("pointer-events", "none");

        simulation.on("tick", () => {
          link
            .attr("x1", (d) => d.source.x)
            .attr("y1", (d) => d.source.y)
            .attr("x2", (d) => d.target.x)
            .attr("y2", (d) => d.target.y);
          node.attr("transform", (d) => `translate(${d.x},${d.y})`);
          glow.attr("transform", (d) => `translate(${d.x},${d.y})`);
          label.attr("x", (d) => d.x).attr("y", (d) => d.y);
        });
      }

      // --- LOGIQUE FILTRES ---
      function update() {
        const showAuth = document.getElementById("cb-auth").checked;
        const showTopic = document.getElementById("cb-topic").checked;
        const showFr = document.getElementById("cb-french").checked;
        const minDeg = parseInt(document.getElementById("slider").value);
        document.getElementById("val-slid").innerText = minDeg;

        // 1. Calcul Visibilit√©
        nodes.forEach((n) => {
          n.visible = true;
          if (n.Type === "author" && !showAuth) n.visible = false;
          // Filtre Min Degree s'applique √† TOUS les topics (G√©n√©raux ET France)
          if (
            (n.Type === "macro_topic" || n.Type === "french_tag") &&
            n.count < minDeg
          )
            n.visible = false;
          if (n.Type === "macro_topic" && !showTopic) n.visible = false;
          if (n.Type === "french_tag" && !showFr) n.visible = false;
        });

        // 2. Nettoyage Orphelins
        links.forEach(
          (l) => (l.visible = l.source.visible && l.target.visible)
        );

        nodes.forEach((n) => {
          if (n.Type === "author" && n.visible) {
            const hasLink = links.some(
              (l) => l.visible && (l.source.id === n.id || l.target.id === n.id)
            );
            // On garde les auteurs 'collab' m√™me s'ils sont isol√©s par le filtre, car ils sont importants
            if (!hasLink && n.france_type === "none") n.visible = false;
          }
        });

        // 3. Application DOM
        node.style("display", (d) => (d.visible ? "block" : "none"));
        label.style("display", (d) => (d.visible ? "block" : "none"));
        link.style("display", (l) => (l.visible ? "block" : "none"));
        glow.style("display", (d) => (d.visible ? "block" : "none"));

        // Stats Live
        const visNodes = nodes.filter((n) => n.visible);
        document.getElementById("st-auth").innerText = visNodes.filter(
          (n) => n.Type === "author"
        ).length;
        document.getElementById("st-topic").innerText = visNodes.filter(
          (n) => n.Type !== "author"
        ).length;
        document.getElementById("st-link").innerText = links.filter(
          (l) => l.visible
        ).length;
      }

      // --- INTERACTIONS ---
      function nodeClick(event, d) {
        event.stopPropagation();
        activeId = d.id;

        // Highlight Voisins
        const neigh = new Set([d.id]);
        links.forEach((l) => {
          if (l.visible && l.source.id === d.id) neigh.add(l.target.id);
          if (l.visible && l.target.id === d.id) neigh.add(l.source.id);
        });

        node.attr("opacity", (n) => (neigh.has(n.id) ? 1 : 0.1));
        label.attr("opacity", (n) => (neigh.has(n.id) ? 1 : 0));
        link.attr("opacity", (l) =>
          l.visible && (l.source.id === d.id || l.target.id === d.id) ? 1 : 0.05
        );

        showDetails(d);
      }

      function bgClick() {
        activeId = null;
        node.attr("opacity", 1);
        link.attr("opacity", 1);
        label.attr("opacity", 1);
        closeDetails();
      }

      function showDetails(d) {
        document.getElementById("default-view").style.display = "none";
        document.getElementById("details-view").style.display = "block";
        const cont = document.getElementById("detail-content");

        let html = `<div class="detail-name">${d.label}</div>`;
        html += `<div style="color:var(--grey); margin-bottom:10px">${
          d.Type === "author" ? d.university : "Topic"
        }</div>`;

        if (d.Type === "author") {
          if (d.france_type === "collab" || d.france_type === "both") {
            html += `<div class="collab-box">
                    <strong>üá´üá∑ Collaboration</strong><br>
                    üèõ ${d.collab_inst}<br>
                    üìÑ <i>"${d.collab_article}"</i><br>
                    üè∑ Th√®me: ${d.collab_theme}
                </div>`;
          } else if (d.france_type === "study") {
            html += `<div style="color:var(--french); margin-top:10px">‚òÖ √âtudie la France</div>`;
          }
        } else {
          html += `<div>Cit√© <strong>${d.count}</strong> fois.</div>`;
        }
        cont.innerHTML = html;
      }

      function closeDetails() {
        document.getElementById("details-view").style.display = "none";
        document.getElementById("default-view").style.display = "block";
      }

      function performSearch() {
        const val = document.getElementById("search").value.toLowerCase();
        if (!val) return;
        const found = nodes.find(
          (n) => n.visible && n.label.toLowerCase().includes(val)
        );

        if (found) {
          // Zoom Focus
          const scale = 2.5;
          const x = -found.x * scale + width / 2;
          const y = -found.y * scale + height / 2;
          svg
            .transition()
            .duration(750)
            .call(zoom.transform, d3.zoomIdentity.translate(x, y).scale(scale));
          nodeClick(new Event("click"), found);
        }
      }

      function resetCam() {
        svg.transition().duration(750).call(zoom.transform, d3.zoomIdentity);
      }

      function toggleSidebar() {
        const sb = document.getElementById("sidebar");
        const btn = document.getElementById("btn-toggle");
        if (sb.classList.contains("hidden")) {
          sb.classList.remove("hidden");
          btn.style.left = "345px";
          btn.innerHTML = "‚ùÆ";
        } else {
          sb.classList.add("hidden");
          btn.style.left = "20px";
          btn.innerHTML = "‚ùØ";
        }
      }

      function drawChart(id, data) {
        const div = d3.select(id);
        const max = data[0][1];
        data.forEach(([k, v]) => {
          const row = div.append("div").attr("class", "bar-item");
          row.append("div").attr("class", "bar-label").text(k).attr("title", k);
          const bg = row.append("div").attr("class", "bar-bg");
          bg.append("div")
            .attr("class", "bar-fill")
            .style("width", (v / max) * 100 + "%");
          row.append("div").attr("class", "bar-num").text(v);
        });
      }

      function dragstart(event, d) {
        if (!event.active) simulation.alphaTarget(0.3).restart();
        d.fx = d.x;
        d.fy = d.y;
      }
      function dragged(event, d) {
        d.fx = event.x;
        d.fy = event.y;
      }
      function dragend(event, d) {
        if (!event.active) simulation.alphaTarget(0);
        d.fx = null;
        d.fy = null;
      }
    </script>
  </body>
</html>
